<usermgmt-addform hidden={!shown} onkeyup={keyup}>
  <form class="content">
    <h2>Add User</h2>
    <div class="form-row">
      <label>Username:</label>
      <input
        type="text"
        name="username"
        class={invalid: !validation.username}
      ></input>
    </div>
    <div class="form-row">
      <label>Full Name:</label>
      <input
        type="text"
        name="fullname"
        class={invalid: !validation.fullname}
      ></input>
    </div>
    <div class="buttons">
      <button type="submit" disabled={!canSubmit()} onclick={save}>
        Add
      </button>
      <button type="reset" onclick={close}>
        Cancel
      </button>
    </div>
  </form>


  <style scoped>
    :scope {
      display: block;
      position: fixed;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.6);
    }
    .content {
      background-color: white;
      margin: 15% auto; /* 15% from the top and centered */
      padding: 20px;
      max-width: 60%;
    }
    .content > h2 {
      margin-top: 0;
    }
    .form-row {
      display: flex;
      margin-bottom: 4px;
    }
    .form-row label {
      width: 30%;
    }
    .form-row input {
      flex-grow: 1;
    }
    .buttons {
      margin-top: 10px;
    }
  </style>


  <script>
    var state = require('../riotapp.state');
    var _ = require('lodash');
    var tag = this;

    tag.shown = false;

    // input validation
    tag.validation = {};
    tag.validation.username = false;
    tag.validation.fullname = false;

    tag.canSubmit = function () {
      return tag.validation.username && tag.validation.fullname;
    }

    tag.validate = function () {
      var usernameValid = true;
      var fullnameValid = true;

      // username and fullname are both required
      if (tag.username.value === '') {
        usernameValid = false;
      }
      if (tag.fullname.value === '') {
        fullnameValid = false;
      }
      // username cannot already exist
      var usernameExists = _.some(state.users, function(user) {
        return user.username === tag.username.value;
      })
      if (usernameExists) {
        usernameValid = false;
      }

      tag.validation.username = usernameValid;
      tag.validation.fullname = fullnameValid;
    };

    /*
    This function is actually called from the parent tag.
    It's unusual and may be an anti-pattern.
    */
    tag.open = function () {
      tag.username.value = '';
      tag.fullname.value = '';
      tag.validation.username = false;
      tag.validation.fullname = false;
      tag.shown = true;
      tag.validate();
      tag.username.focus() // not working for some reason
    };

    tag.close = function () {
      tag.shown = false;
    };

    tag.save = function () {
      // trigger action on app state
      state.addUser(tag.username.value, tag.fullname.value);
      // close the editor
      tag.close();
    };

    tag.keyup = function (e) {
      tag.validate();
      // handle escape key
      if (e.keyCode === 27) {
        tag.close();
      }
    }

  </script>

</usermgmt-addform>
